tinymce.PluginManager.add('caption', function (ed, url) {
    ed.addButton('caption', {
        text: 'Caption',
        icon: false,
        onclick: function () {
            var element = ed.selection.getNode();
            var parent = element.parentElement;
            currentCaption = parent.getAttribute('data-label')
            captionWindowTitle = currentCaption ? 'Edit Caption' : 'Add Caption'

            ed.windowManager.open({
                title: captionWindowTitle,
                body: [
                    {type: 'textbox', name: 'caption', label: 'Caption', value: currentCaption}
                ],
                onsubmit: function (e) {
                    var caption = e.data.caption;
                    var containerClassName = 'image-container';
                    var containerNoCaptionClassName = 'no-caption';
                    var parentClassName = parent.className;

                    if(parentClassName === containerClassName || parentClassName === containerNoCaptionClassName){
                        if (!caption)
                            parent.className = containerNoCaptionClassName;
                        else
                            parent.className = containerClassName;
                        parent.setAttribute('data-label', caption);
                        return;
                    }

                    var dom = ed.dom;
                    var container = dom.create('div', {'class': containerClassName,
                        'data-label': caption,
                        'style': element.getAttribute('style')});
                    element.setAttribute('style', '');
                    dom.insertAfter(container, element);
                    container.appendChild(element);
                }
            });
        }
    });
});