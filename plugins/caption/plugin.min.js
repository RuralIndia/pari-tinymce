tinymce.PluginManager.add('caption', function (ed, url) {
    ed.addButton('caption', {
        text: 'Caption',
        icon: false,
        onclick: function () {
            var element = ed.selection.getNode(),
                parent = element.parentElement,
                currentCaption = parent.getAttribute('data-label');

            ed.windowManager.open({
                title: currentCaption ? 'Edit Caption' : 'Add Caption',
                body: [
                    {type: 'textbox', name: 'caption', label: 'Caption', value: currentCaption}
                ],
                onsubmit: function (e) {
                    var updatedCaption = e.data.caption,
                        imgContainerClass = 'image-container';

                    if(parent.className === imgContainerClass){
                        parent.setAttribute('data-label', updatedCaption);
                        return;
                    }

                    var dom = ed.dom;
                    var container = dom.create('a', {'class': imgContainerClass,
                        'data-label': updatedCaption,
                        'href': '',
                        'style': element.getAttribute('style')});
                    element.setAttribute('style', '');
                    dom.insertAfter(container, element);
                    container.appendChild(element);

                    var containerWrapper = dom.create('span', {'class': 'image-container-wrapper' });
                    dom.insertAfter(containerWrapper, container);
                    containerWrapper.appendChild(container);
                }
            });
        }
    });
});